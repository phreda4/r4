| eval-code.txt
| PHREDA 2007
|---------------------------------------
^reda4.txt
^libgui.txt
^r4code.txt
^medit.txt

#nombre )( 64
#linea )( 1024	| error y mem aux

#primerword
#:hojapal 0

#pilavars )( 1024
#pilavars> 'pilavars

::+variable | nroword --
	pilavars> !+ 'pilavars> ! ;

::-executa | --
	-4 'pilavars> +! ;

:printwordal | n --
	4 << 'indicepal +
	@+ "%w " print @+ " %h  " print @+ " %h  " print @+ " %h  " print cr
	drop ;

|----------------- muestra lista palabras
::printwordname | n --
|	dup "%d." blanco print | nro de palabra
	4 << 'indicepal +
	indicepal> >=? ( drop ; )
	dup 8 + @ 1 and? ( drop @ "#%w " violeta print ; ) drop
	@+ ":%w " rojo print
	drop
	;
:ll
	verde
	@+ drop |"%d " print direccion
	@+
	dup 24 >> "%d" print
	dup 8 << 24 >> "%d" print
	$fff and  "%b" print
| 	"%h" print
	@ "%d" print
	;

:drawtoken
	fonti
	primerword
	fils ( 1? )( 1- swap
|		actword =? ( vidi )
|		dup printwordal
		dup printwordname cr
|		actword =? ( vidi )
		1+ swap  )
	2drop
	;

|------------------ definicion con ayuda
:tokeninfolist | cnt adr --
	( swap 1? )( 1- swap | cnt adr
		|dup "%h :" print
		<<ip =? ( vidi )
|		dup 4 - movstackprint
		tokenprint
		<<ip 4+ =? ( vidi )
		over $7 and 0? ( cr ) drop
		" " print ) 2drop ;


:esvar | adr --
	@ "#%w " violeta print cr
 	;

:exprintword | n --
	4 << 'indicepal +
	indicepal> >=? ( drop ; )
	dup 8 + @ 1 and? ( drop esvar ; ) drop
	dup @ ":%w " rojo print
	dup 12 + @
	swap 4+ @
	tokeninfolist ;

:drawtrace
	fonti
	dumpvm
	'pilaexe
	( pilaexe> <? )(
		@+ exprintword cr ) drop
	;

|------------------ dibuja la memoria
:printvariable | n --
	4 << 'indicepal +
	indicepal> >=? ( drop ; )
	dup 8 + @ 1 nand? ( 2drop ; ) drop
	@+ "#%w " violeta print amarillo
	@ @ " %d " print
|	drop
	;

:drawmemvar
	fonti
	'pilavars
	( pilavars> <? )(
		@+ printvariable cr ) drop
	;

|------------------ estado MV
:drawstat
	fonti

	cntvars cntword "pal:%d vars:%d " print cr amarillo
	str> str - 	cte> cte - 2 >> prog> prog - 2 >> "tok:%d cons:%d str:%d" print cr
	<<ip "IP:%h " verde print rojo
	<<ip @ dup $ff and swap 8 >> swap "%d-%d" print
	;

:realplay
	'nombre run  ;

#newbotonera 5
$ff0000 'ifin   'exit
$00ff00	'iplay	'stepvm
$00ff00	'iff	'playvm
0 0 0
0 0 0

:botonera
	'newbotonera escf1..
	;

:titulo
	$444444 $cccccc vbtn
	1 sfont amarillo "r4Eval: " print
	blanco 'nombre print
    msg 1? ( cr rojo print )( drop )
|	'eligearchivo onUp
	;

:consolag
	2 font blanco m.draw ;

#guiconsola
0.96 0.06 0 -0.46 'titulo
0.5 0.1 -0.25 0.45 'botonera

0.5 0.5 -0.25 -0.15  'drawtoken
0.5 0.5 0.25 -0.15  'drawmemvar

1.0 0.4 0 0.2 'drawtrace
0.5 0.1 0.25 0.45 'drawstat
0

:consola
	indicepal< 'indicepal - 4 >> | iniciodicc
	'primerword !

	indicepal> 'indicepal - 4 >> | fin dicc
	1- dup +executa

	( primerword 1- >? )(
		dup	4 << 'indicepal +
		8 + @ 1 and? ( over +variable ) drop
		1- ) drop

|	indicepal> 12 - @ 'actual> !
|	ajusta
	inikey
	'exit >esc<
	'stepvm <f1>
	'stepvmf <f2>

	startvm

	show cls scr
		'guiconsola gui
		cmano ;

|----- Sistema
:errorcompila
	'linea dup >, saverror count "debug.err" save
	"edit-code.txt" run ;

:errorpost
	;

|----------- principal
:main
	'nombre "./nom/editor.nom" load drop
	clear
	'nombre tokencomp
	msg 1? ( drop errorcompila ; ) drop
	tokenpost |savestat
	msg 1? ( drop errorpost ; ) drop
	consola
	;

: 0 paper 4 main "edit-code.txt" run  ;