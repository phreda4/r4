| traverse test
| PHREDA 2014
|-----------------------------
^r4/lib/gui.txt
^r4/lib/trace.txt

^r4/dev/octree/wirelib.txt

|------ vista
#xcam 0 #ycam 0 #zcam 3.0

#tx0	#tx1
#ty0    #ty1
#tz0	#tz1

#ox #oy #oz

:getval | x y -- x y c
	2dup 512 normInt2Fix
	transform
	neg oz + 1? ( 1.0 swap /. )
	-0.5 oz - over *. 0.5 oz - rot *.
	over <? ( swap )
	'tz1 ! 'tz0 !

	neg oy + 1? ( 1.0 swap /. )
	-0.5 oy - over *. 0.5 oy - rot *.
	over <? ( swap )
	'ty1 ! 'ty0 !

	neg ox + 1? ( 1.0 swap /. )
	-0.5 ox - over *. 0.5 ox - rot *.
	over <? ( swap )
	'tx1 ! 'tx0 !

	tx0 ty0 tz0 max max
	tx1 ty1 tz1 min min
|	-
	>? ( $ff )( $ff00 ) nip
	;

:tracetest
	matinv
	0 0 0 transform 'oz ! 'oy ! 'ox !
	-256 ( 256 <? )(
		-256 ( 256 <? )(
|			sw 2/ pick2 - sh 2/ pick2 - setxy
			over sw 2/ + over sh 2/ + setxy
			getval px!+
			4+ ) drop
		4+ ) drop
	;


:mousetest
	0 0 0 transform 'oz ! 'oy ! 'ox !

	xymouse swap sw 2/ - swap sh 2/ -
	2dup "%d %d" print cr
	512
	normInt2Fix transform

	neg oz + 1? ( 1.0 swap /. )
	-0.5 oz - over *. 0.5 oz - rot *.
	over <? ( swap )
	'tz1 ! 'tz0 !

	neg oy + 1? ( 1.0 swap /. )
	-0.5 oy - over *. 0.5 oy - rot *.
	over <? ( swap )
	'ty1 ! 'ty0 !

	neg ox + 1? ( 1.0 swap /. )
	-0.5 ox - over *. 0.5 ox - rot *.
	over <? ( swap )
	'tx1 ! 'tx0 !

	tx0 ty0 tz0 max max
	tx1 ty1 tz1 min min
	>? ( drop ; ) drop

	;

:freelook
	xymouse
	sh 2/ - 7 << swap
	sw 2/ - neg 7 << swap
	neg mrotx
	mroty ;

:main
	4 show clrscr
		3dini
|		freelook
		xcam ycam zcam mtrans

		draw3dgrid
		tracetest

		mousetest

		verde
		tz0 ty0 tx0 "%f %f %f " print cr
		tz1 ty1 tx1 "%f %f %f " print cr

		[ 0.1 'zcam +! ; ] <dn>
		[ -0.1 'zcam +! ; ] <up>
		[ 0.1 'xcam +! ; ] <le>
		[ -0.1 'xcam +! ; ] <ri>
		[ 0.1 'ycam +! ; ] <pgup>
		[ -0.1 'ycam +! ; ] <pgdn>


		'exit >esc<
		cminiflecha ;

: mark main ;
