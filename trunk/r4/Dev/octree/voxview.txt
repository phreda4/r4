| Editor de Voxels
| PHREDA 2014
|-----------------------------
^r4/lib/gui.txt
^r4/lib/sort.txt
^r4/lib/bsearch.txt
^r4/lib/morton.txt

^r4/lib/trace.txt

#sidevox 256
#deepvox 8
#BITVOX 7 | profundidad-1

#paleta )( 1024

#xcam 0 #ycam 0 #zcam 2048

#octre
#octre>

|----------- busca masa
:calcnext | busca nodo value now -- busca nodo+
	1- over and popcnt4 swap 6 >> $fffffffc and
	+
	| + | cuando es incrementa
	octre + nip | cuando es cte
	;

:esta | x y z -- m
	morton3d octre		| busca nodo

	@+ pick2 21 >> $7 and place | busca nodo value now
	2dup and 0? ( nip nip nip nip ; ) drop
    calcnext
	@+ pick2 18 >> $7 and place | busca value now
	2dup and 0? ( nip nip nip nip $ff nip ; ) drop	| no hay nadie
	calcnext
	@+ pick2 15 >> $7 and place | busca value now
	2dup and 0? ( nip nip nip nip $ff00 nip ; ) drop	| no hay nadie
	calcnext
	@+ pick2 12 >> $7 and place | busca value now
	2dup and 0? ( nip nip nip nip $ff0000 nip ; ) drop	| no hay nadie
	calcnext
	@+ pick2 9 >> $7 and place | busca value now
	2dup and 0? ( nip nip nip nip $ffff00 nip ; ) drop	| no hay nadie
	calcnext
	@+ pick2 6 >> $7 and place | busca value now
	2dup and 0? ( nip nip nip nip $ff00ff nip ; ) drop	| no hay nadie
	calcnext
	@+ pick2 3 >> $7 and place | busca value now
	2dup and 0? ( nip nip nip nip $ffffff nip ; ) drop	| no hay nadie
	calcnext
	@+ pick2 $7 and place | busca value now
	2dup and 0? ( nip nip nip nip $c0c0c0 nip ; ) drop	| no hay nadie
	1- over and popcnt4 swap 6 >> $fffffffc and +
	octre + nip
	nip ;

:masa | x y z -- color m
	morton3d octre		| busca nodo

	@+ pick2 21 >> $7 and place | busca nodo value now
	2dup and 0? ( nip nip nip nip 128 ; ) drop
    calcnext
	@+ pick2 18 >> $7 and place | busca value now
	2dup and 0? ( nip nip nip nip $ff nip 64 ; ) drop	| no hay nadie
	calcnext
	@+ pick2 15 >> $7 and place | busca value now
	2dup and 0? ( nip nip nip nip $ff00 nip 32 ; ) drop	| no hay nadie
	calcnext
	@+ pick2 12 >> $7 and place | busca value now
	2dup and 0? ( nip nip nip nip $ff0000 nip 16 ; ) drop	| no hay nadie
	calcnext
	@+ pick2 9 >> $7 and place | busca value now
	2dup and 0? ( nip nip nip nip $ffff00 nip 8 ; ) drop	| no hay nadie
	calcnext
	@+ pick2 6 >> $7 and place | busca value now
	2dup and 0? ( nip nip nip nip $ff00ff nip 4 ; ) drop	| no hay nadie
	calcnext
	@+ pick2 3 >> $7 and place | busca value now
	2dup and 0? ( nip nip nip nip $ffffff nip 2 ; ) drop	| no hay nadie
	calcnext
	@+ pick2 $7 and place | busca value now
	2dup and 0? ( nip nip nip nip $c0c0c0 nip 1 ; ) drop	| no hay nadie
	1- over and popcnt4 swap 6 >> $fffffffc and +
	octre + nip
	nip ;

|---- otra forma
#nodo

| x y z -- x y z m
:get1	dup 1 and pick2 2* 2 and or pick3 2 << 4 and or place ;
:get2	dup 2/ 1 and pick2 2 and or pick3 2* 4 and or place ;
:get3	dup 2 >> 1 and pick2 2/ 2 and or pick3 4 and or place ;
:get4	dup 3 >> 1 and pick2 2 >> 2 and or pick3 2/ 4 and or place ;
:get5	dup 4 >> 1 and pick2 3 >> 2 and or pick3 2 >> 4 and or place ;
:get6	dup 5 >> 1 and pick2 4 >> 2 and or pick3 3 >> 4 and or place ;
:get7	dup 6 >> 1 and pick2 5 >> 2 and or pick3 4 >> 4 and or place ;
:get8	dup 7 >> 1 and pick2 6 >> 2 and or pick3 5 >> 4 and or place ;
:get9	dup 8 >> 1 and pick2 7 >> 2 and or pick3 6 >> 4 and or place ;
:get10	dup 9 >> 1 and pick2 8 >> 2 and or pick3 7 >> 4 and or place ;

:nexto | now value
    swap 1- over and popcnt4 swap 6 >> $fffffffc and + ;

:binhit | x y z -- x y z m
	octre >r
	get8 r@+ | now value
	over nand? ( 2drop r> 'nodo ! 128 ; )
 	nexto
	| r+
	octre + rdrop >r

	get7 r@+ | now value
	over nand? ( 2drop r> 'nodo ! 64 ; )
	nexto
	| r+
	octre + rdrop >r

	get6 r@+ | now value
	over nand? ( 2drop r> 'nodo ! 32 ; )
	nexto
	| r+
	octre + rdrop >r

	get5 r@+ | now value
	over nand? ( 2drop r> 'nodo ! 16 ; )
	nexto
	| r+
	octre + rdrop >r

	get4 r@+ | now value
	over nand? ( 2drop r> 'nodo ! 8 ; )
	nexto
	| r+
	octre + rdrop >r

	get3 r@+ | now value
	over nand? ( 2drop r> 'nodo ! 4 ; )
	nexto
	| r+
	octre + rdrop >r

	get2 r@+ | now value
	over nand? ( 2drop r> 'nodo ! 2 ; )
	nexto
	| r+
	octre + rdrop >r

	get1 r@+ | now value
	over nand? ( 2drop r> 'nodo ! 1 ; )
	nexto
	| r> +
	octre + rdrop
	'nodo !
	0 ;

|----------- graficacion
#rx
#ry
:freelook
	xymouse
	sh 2/ - 7 << swap
	sw 2/ - neg 7 << swap
	neg mrotx mroty ;

:drawp | x y z ---
	project3d |2dup op line ;
	-? ( 2drop ; ) sh >=? ( 2drop ; )
	swap -? ( 2drop ; ) sw >=? ( 2drop ; ) swap
	setxy ink@ px!+ ;

:3dop project3d op ;
:3dline project3d line ;

|---- dibujos de grillas
:drawboxz | z --
	-$1ff -$1ff pick2 3dop
	$1ff -$1ff pick2 3dline
	$1ff $1ff pick2 3dline
	-$1ff $1ff pick2 3dline
	-$1ff -$1ff rot 3dline ;

:drawboxy | y --
	-$1ff over -$1ff 3dop
	$1ff over -$1ff 3dline
	$1ff over $1ff 3dline
	-$1ff over $1ff 3dline
	-$1ff swap -$1ff 3dline ;

:drawboxx | x --
	dup -$1ff -$1ff 3dop
	dup $1ff -$1ff 3dline
	dup $1ff $1ff 3dline
	dup -$1ff $1ff 3dline
	-$1ff -$1ff 3dline ;

:drawlinez | x1 x2 --
	2dup -$1ff 3dop $1ff 3dline ;

:draw3dbox
	$707070 ink
	-$1ff drawboxz
	$1ff drawboxz
	-$1ff -$1ff drawlinez
	$1ff -$1ff drawlinez
	$1ff $1ff drawlinez
	-$1ff $1ff drawlinez ;


|--------- ortho vistas
:getcolor
	nodo 4+ @ ;

:rayx | xi y z -- color
	rot	| y z x
	( 256 <? )( rot rot | x y z
		binhit 0? ( 4drop getcolor ; )
		>r rot r> + )
	3drop 0 ;

:tracexplane | x y --
	0 ( sidevox <? )(
		pick2 pick2 setxy
		0 ( sidevox <? )(
			0 pick2 pick2 rayx px!+
			1+ ) drop
		swap 1+ swap 1+ ) 3drop
	;

:rayy | x yi z -- color
	swap | x z y
	( 256 <? )( swap | x y z
		binhit 0? ( 4drop getcolor ; )
		rot + )
	3drop 0 ;

:traceyplane | x y --
	0 ( sidevox <? )(
		pick2 pick2 setxy
		0 ( sidevox <? )(
			over 0 pick2 rayy px!+
			1+ ) drop
		swap 1+ swap 1+ ) 3drop
	;

:rayz | x y zi -- color
	( 256 <? )(
		binhit 0? ( 4drop getcolor ; )
		+ )
	3drop 0 ;

:tracezplane | x y --
	0 ( sidevox <? )(
		pick2 pick2 setxy
		0 ( sidevox <? )(
			over over 0 rayz px!+
			1+ ) drop
		swap 1+ swap 1+ ) 3drop
	;

|------------- load import
:load3do | "filename" --
	octre swap load 'octre> ! ;


|--------------------------
:memory
	mark
	here dup 'octre ! 'octre> !
	;

:main
	"media/3do/castle.3do" load3do
	4
	show clrscr verde
		dup ":r%d " print cr

		10 40 traceyplane

		260 40 tracexplane

		500 40 tracezplane

|		[ -0.01 'zcam +! ; ] <up>
|		[ 0.01 'zcam +! ; ] <dn>

		'exit >esc< ;

: memory main ;
