| Editor de Voxels
| PHREDA 2014
|-----------------------------
^r4/lib/gui.txt
^r4/lib/sort.txt
^r4/lib/bsearch.txt
^r4/lib/morton.txt

^r4/lib/trace.txt

#sidevox 512

#paleta )( 1024

#xcam 0 #ycam 0 #zcam 2048

#pixels
#octre
#octre>

#pixels2
#octre2
#octre2>

|----------- busca masa
#nodo

:nexto | now value -- newa
	dup rot 1- and popcnt swap 8 >> + ;

:binhit | x y z -- x y z m
	pick2 pick2 pick2 mortonlut octre

	over 27 >> $7 and place swap @ over nand? ( 3drop 512 ; ) nexto 2 << octre +
	over 24 >> $7 and place swap @ over nand? ( 3drop 256 ; ) nexto 2 << octre +

	over 21 >> $7 and place swap @ over nand? ( 3drop 128 ; ) nexto 2 << octre +
	over 18 >> $7 and place swap @ over nand? ( 3drop 64 ; ) nexto 2 << octre +
	over 15 >> $7 and place swap @ over nand? ( 3drop 32 ; ) nexto 2 << octre +
	over 12 >> $7 and place swap @ over nand? ( 3drop 16 ; ) nexto 2 << octre +
	over 9 >> $7 and place swap @ over nand? ( 3drop 8 ; ) nexto 2 << octre +
	over 6 >> $7 and place swap @ over nand? ( 3drop 4 ; ) nexto 2 << octre +
	over 3 >> $7 and place swap @ over nand? ( 3drop 2 ; ) nexto 2 << octre +
	swap $7 and place swap @ over nand? ( 2drop 1 ; )
	nexto 'nodo ! 0  ;

|----------- graficacion
#rx
#ry
:freelook
	xymouse
	sh 2/ - 7 << swap
	sw 2/ - neg 7 << swap
	neg mrotx mroty ;

:drawp | x y z ---
	project3d |2dup op line ;
	-? ( 2drop ; ) sh >=? ( 2drop ; )
	swap -? ( 2drop ; ) sw >=? ( 2drop ; ) swap
	setxy ink@ px!+ ;

:3dop project3d op ;
:3dline project3d line ;

|---- dibujos de grillas
:drawboxz | z --
	-$1ff -$1ff pick2 3dop
	$1ff -$1ff pick2 3dline
	$1ff $1ff pick2 3dline
	-$1ff $1ff pick2 3dline
	-$1ff -$1ff rot 3dline ;

:drawboxy | y --
	-$1ff over -$1ff 3dop
	$1ff over -$1ff 3dline
	$1ff over $1ff 3dline
	-$1ff over $1ff 3dline
	-$1ff swap -$1ff 3dline ;

:drawboxx | x --
	dup -$1ff -$1ff 3dop
	dup $1ff -$1ff 3dline
	dup $1ff $1ff 3dline
	dup -$1ff $1ff 3dline
	-$1ff -$1ff 3dline ;

:drawlinez | x1 x2 --
	2dup -$1ff 3dop $1ff 3dline ;

:draw3dbox
	$707070 ink
	-$1ff drawboxz
	$1ff drawboxz
	-$1ff -$1ff drawlinez
	$1ff -$1ff drawlinez
	$1ff $1ff drawlinez
	-$1ff $1ff drawlinez ;


|--------- ortho vistas
:getcolor
	nodo 2 << pixels + @ ;

:rayx | xi y z -- color
	rot	| y z x
	( 256 <? )( rot rot | x y z
		binhit 0? ( 4drop getcolor ; )
		>r rot r> + )
	3drop 0 ;

:tracexplane | x y --
	0 ( sidevox <? )(
		pick2 pick2 setxy
		0 ( sidevox <? )(
			0 pick2 pick2 rayx px!+
			1+ ) drop
		swap 1+ swap 1+ ) 3drop
	;

:rayy | x yi z -- color
	swap | x z y
	( 1024 <? )( swap | x y z
		binhit 0? ( 4drop getcolor ; )
		rot + )
	3drop 0 ;

:traceyplane | x y --
	0 ( sidevox <? )(
		pick2 pick2 setxy
		0 ( sidevox <? )(
			over 0 pick2 rayy px!+
			1+ ) drop
		swap 1+ swap 1+ ) 3drop
	;

:rayz | x y zi -- color
	( 256 <? )(
		binhit 0? ( 4drop getcolor ; )
		+ )
	3drop 0 ;

:tracezplane | x y --
	0 ( sidevox <? )(
		pick2 pick2 setxy
		0 ( sidevox <? )(
			over over 0 rayz px!+
			1+ ) drop
		swap 1+ swap 1+ ) 3drop
	;

|------------- load import
:load3do | "filename" --
	octre swap load 'octre> !
	octre> 4 - @ octre + 'pixels !
	octre> 'octre2 !
	;

:load3do2 | "filename" --
	octre2 swap load 'octre2> !
	octre2> 4 - @ octre2 + 'pixels2 !
	;

:swapoc
	octre octre2 'octre ! 'octre2 !
	octre> octre2> 'octre> ! 'octre2> !
	pixels pixels2 'pixels ! 'pixels2 !
	;

|---
#t1 #t2 #t3 #t4
:testhit
	;

|--------------------------
:memory
	mark
	here 'octre ! ;

:main

|	"media/3do/bamboo.3do"
|	"media/3do/mario.3do"

|	"media/3do/cesna.3do"
	"media/3do/luigi.3do"
|	"media/3do/castle.3do"
|	"media/3do/porche1.3do"
	load3do

	load3do2

	4
	show clrscr verde
		dup ":r%d " print cr
		octre pixels "%h %h " print cr

		10 40 traceyplane
|		270 40 tracexplane
|		530 40 tracezplane

|		[ -0.01 'zcam +! ; ] <up>
|		[ 0.01 'zcam +! ; ] <dn>

		'swapoc <f1>

		'exit >esc< ;

: memory main ;
