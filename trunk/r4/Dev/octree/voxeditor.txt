| genera vista de octree
| PHREDA 2012
|-----------------------------
^r4/lib/gui.txt
^r4/lib/fontj.txt
^r4/lib/trace.txt

#maxvox 512

#sidevox 16
#deepvox 4
#maskvox $f

#addside

#paleta )( 1024
#xmin #ymin #zmin #xmax #ymax #zmax

#xcam 0 #ycam 0 #zcam 2048

#memvox
#octre
#octre>

|----------- graficacion
#rx
#ry
:freelook
	xymouse
	sh 2/ - 7 << swap
	sw 2/ - neg 7 << swap
	neg mrotx mroty ;

:drawp | x y z ---
	project3d |2dup op line ;
	-? ( 2drop ; ) sh >=? ( 2drop ; )
	swap -? ( 2drop ; ) sw >=? ( 2drop ; ) swap
	setxy ink@ px!+ ;

:3dop project3d op ;
:3dline project3d line ;

|---- dibujos de grillas
:drawboxz | z --
	-$1ff -$1ff pick2 3dop
	$1ff -$1ff pick2 3dline
	$1ff $1ff pick2 3dline
	-$1ff $1ff pick2 3dline
	-$1ff -$1ff rot 3dline ;

:drawboxy | y --
	-$1ff over -$1ff 3dop
	$1ff over -$1ff 3dline
	$1ff over $1ff 3dline
	-$1ff over $1ff 3dline
	-$1ff swap -$1ff 3dline ;

:drawboxx | x --
	dup -$1ff -$1ff 3dop
	dup $1ff -$1ff 3dline
	dup $1ff $1ff 3dline
	dup -$1ff $1ff 3dline
	-$1ff -$1ff 3dline ;

:drawlinez | x1 x2 --
	2dup -$1ff 3dop $1ff 3dline ;

:draw3dbox
	$707070 ink
	-$1ff drawboxz
	$1ff drawboxz
	-$1ff -$1ff drawlinez
	$1ff -$1ff drawlinez
	$1ff $1ff drawlinez
	-$1ff $1ff drawlinez ;

| grilla total.
:draw3dgrid
	$707070 ink
	-$1ff00
	sidevox 1+
	( 1? )( 1-
		swap
		dup 8 >> drawboxy
		dup 8 >> drawboxx
		addside +
		swap ) 2drop
	-$1ff00 addside +
	sidevox 1-
	( 1? )( 1-
		swap dup 8 >> drawboxz
		addside +
		swap ) 2drop
	;

|-----------------------------
:setparamvox
	$3ff00 sidevox / 'addside !
	1 deepvox << 1- 'maskvox !
	;

|--------------------------
:clearvox
	sidevox dup dup * * 2 <<
	memvox >r
	( 1? )( -1 r!+ 1- ) drop
	rdrop ;

:vox! | color x y z
	maskvox and deepvox <<
	swap maskvox and or deepvox <<
	swap maskvox and or
	2 << memvox + ! ;

:vox@ | x y z -- color
	maskvox and deepvox <<
	swap maskvox and or deepvox <<
	swap maskvox and or
	2 << memvox + @ ;

:randvox
	sidevox dup dup * *
	( 1? )( 1-
		rand rand rand rand vox!
		) drop
	;

#curx 0 #cury 0 #curz 0

:drawplanexbox | x y --
	0 ( sidevox <? )(
		pick2 pick2 setxy
		0 ( sidevox <? )(
			curx pick2 pick2 vox@ -1 =? ( 1 px+! drop )( px!+ )
			1+ ) drop
		swap 1+ swap
		1+ ) 3drop
	;

|--------------------------
:memory
	mark
	here 'memvox !
	maxvox dup dup * * 'here +!
	clearvox
	;

:main
	setparamvox

	randvox

	4
	show clrscr verde
		dup ":r%d " print
		sidevox Deepvox "DEEP:%d SIDE:%d" print cr
		curz cury curx "%d %d %d" print
		omode
		freelook
		xcam ycam zcam mtrans
		draw3dbox

		5 5 drawplanexbox


|		[ -0.01 'zcam +! ; ] <up>
|		[ 0.01 'zcam +! ; ] <dn>

		[ 1 'curx +! ; ] <up>
		[ -1 'curx +! ; ] <dn>
		[ 1 'cury +! ; ] <le>
		[ -1 'cury +! ; ] <ri>
		[ 1 'curz +! ; ] <pgup>
		[ -1 'curz +! ; ] <pgdn>

		'exit >esc< ;

: memory main ;
