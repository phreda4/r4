| bubles
| PHREDA 2012

^r4/lib/gui.txt
^r4/dev/simple.spr

|------ particulas de 8 valores
:pini | cantidad list --
	here dup rot !+ ! 5 << 'here +! ;

:pclear | list --
	dup 4+ @ swap ! ;

:p!+ | 7 6 5 4 3 2 1 'acc list --
	dup >r @ !+ !+ !+ !+ !+ !+ !+ !+ r> ! ;

:pmap | list --
	@+ swap @
	( over <? )(
		dup @+ exec
		32 + ) 2drop ;

:delp | list end now -- list end- now-
	swap 32 - 2dup 8 move
	dup pick3 !
	swap 32 - ;

:pmap0 | list --
	dup @+ swap @
	( over <? )(
		dup @+ exec 0? ( drop delp )
		32 + ) 3drop ;

:pdel | adr list --
	>r r @ 32 - 8 move r> dup @ 32 - swap ! ;

:pmapv | 'vector list --
	@+ swap @
	( over <? )(
		pick2 exec
		32 + ) 3drop ;

|.......
:isin | x y 'end 'now -- x y end now/ x y now 0
	dup 4+ @ pick4 - abs 0.06 >? ( drop ; ) drop
	dup 8 + @ pick3 - abs 0.06 >? ( drop ; ) drop
	nip 0 ; | 'now 0

:pin | x y 'list -- x y 'how/x y 0
	@+ swap @
	( over <? )(
		isin 0? ( drop ; )
		32 + )
	2drop 0 ;

|........
:pmapmap | 'adr 'list 'vec --
	>r
	@+ swap @
	( over <? )(
		pick2 over <>? ( r exec )( drop )
		32 + )
	2drop rdrop ;

:pmap2 | 'vec 'list ---
	@+ swap @
	( over <? )(
		dup 32 + ( pick2 <? )(
			pick3 exec
			32 + ) drop
		32 + )
	3drop ;

|----------------------------------------

#bubles 0 0

:resetgame
	'bubles pclear
	;

|---------
:r.01 rand 0.01 mod ;
:r.1 rand 0.1 mod ;
:r.8 rand 0.8 mod ;

:collision | 'p1 'p2 -- 'p1
	"*" print
	drop
	;

:bub | adr -- adr/adr 0 delete
|	'bubles collisionbox 1? ( 2drop crash ; )( drop ) | 'fire 'aliens collisionbox
|	'bubles 'collision pmapmap
 	>r
	r@+ dup abs
	0.99 >? ( r 4+ dup @ neg swap ! ) drop
	r@+ dup abs
	1.1 >? ( rdrop 3drop 0 ; )
	0.99 >? ( r 4+ dup @ neg swap ! ) drop
	fpos
	r@+ r 12 - +!
	r @ 0.001 - r ! | gravedad
	r@+ r 12 - +!
	rdrop
	0.08 dup fdim
	'coso1 nsprite
	;


:+buble
	0 0 0 r.01 r.01 r.8 r.8 'bub 'bubles p!+ ;

:collision | p1 -- p1
	'bubles
	@+ swap @ 
	( over <? )(
		pick2 <>? ( "*" print )
		32 + )
	2drop ;

:collision | p1 p2 -- p1 p2
	over 4+ @
	over 4+ @ - dup *.
	pick2 8 + @
	pick2 8 + @ - dup *. +

	"%f " print ;


:main
	resetgame
	show clrscr
		scr home blanco
		dup "%d " print

		'bubles pmap0
		'collision 'bubles pmap2
		'+buble <spc>
		'exit >esc< ;

:inicio
	mark
	1000 'bubles pini
	;

: inicio 33 main ;

