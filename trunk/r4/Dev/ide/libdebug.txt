| lib debug
| 2014 PHREDA
|---------------------------
^r4/lib/gui.txt
^r4/lib/parse.txt
^r4/lib/codecolor.txt

^r4/dev/ide/tokenr4.txt
^r4/dev/ide/postr4.txt

^r4/lib/dlgfile.txt

#filename )( 1024
#code
#error
#rsize 40
#iniword

:tokeniza
	diccreset
	code loadincludes 1? ( errormsg 'error ! ; ) drop
	code code2token 1? ( errormsg 'error ! ; ) drop
    tokenpost
	"Ok." 'error !
	cntwords rsize - 1+
	-? ( 0 nip ) 'iniword !
	;


|--- dibuja movimiento pilas
:ncar | n car -- car
	( swap 1? )( 1- swap dup emit 1+ ) drop ;

:printusestack | mov --
	97 >r
	dup 16 << 24 >> | usedD
	neg dup r> ncar >r
	"--" print
	over 24 << 24 >> + | deltaD
	r> ncar >r
	12 << 28 >>
	0 <? ( dup " R:--" print neg r> ncar >r )
	0 >? ( dup " R:" print r> ncar >r )
	drop rdrop ;

:printcomment | inf --
	dup 12 >> $fff and
	0? ( "NOUSO " print )		| no usada
	drop
	1 and? ( 
		$4 nand? ( "CTE " print )	| dato constante
	)(
		$20 and? ( "REC " print )	| recursivo
		$80 and? ( "CON " print )	| continuo (sin ;)
	)
	drop
	;

|----------
:fixbin | nro bits --
	( 1? )( 1- swap
		dup 1 and $30 + emit
		2/ swap ) 2drop ;

:drawline | nro -- nro
	cntwords >? ( ; )
	blanco
	dup 4 << 'indicepal +
	@+ "%s" print
	@+ swap |"%h" print
	10 col
	@+
	dup 24 >> $ff and "%d " print
	dup 12 >> $fff and
|	0? ( 4drop ; )	| si no es llamada no mostrar
	"%d-" print

printcomment
|	$fff and 12 fixbin |"%b" print
	28 col
	@
	dup
	sp printusestack sp

|	dup 24 << 24 >> "D%d " print
|	dup 16 << 24 >> "U%d " print
|	dup 12 << 28 >> "R%d " print
	20 >> $fff and "(%d)" print
	over dic>len@ ( 1? )( 1- swap @+ tokencolor tokenstr print sp swap ) 2drop
	;

:drawline2 | nro
	cntwords >? ( ; )
	blanco
	dup 4 << 'indicepal +
	@+ "%s " print
	4+ @+	| inf
	swap @ 	| inf mov
	printusestack
	drop
	;

:drawwords
	iniword
	rsize ( 1? )( 1- swap
		drawline cr
		1+ swap ) 2drop ;

:loadfile
	"r4" dlgfileload 0? ( drop ; )
	dup 'filename strcpy
	here dup 'code ! swap load 0 swap c!+ 'here !
	tokeniza
	;

:saveimg
	;

:codeprint
	'tokencod ( tokencod> <? )(
		@+ tokencolor tokenstr allowcr print sp
		) drop
	;


:main
	0 'iniword !

	"wait" 'error !
	4
	show clrscr
		fonti
		dup "%d " print
		error 'filename "%s %s" print cr

		cr
		drawwords

|		stackinc
|		dumpinc
|		dumpdic
|		codeprint

		[ iniword cntwords rsize - <=? ( 1+ ) 'iniword ! ; ] <dn>
		[ iniword 1? ( 1- ) 'iniword ! ; ] <up>
		[ iniword rsize + cntwords rsize - >? ( cntwords rsize - 1+ nip ) 'iniword ! ; ] <pgdn>
		[ iniword rsize - -? ( 0 nip ) 'iniword ! ; ] <pgup>

		'loadfile <f1>
		'saveimg <f3>

		'exit >esc<
		cminiflecha ;

: mark main ;
