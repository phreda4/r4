| lib debug
| 2014 PHREDA
|---------------------------
^r4/lib/gui.txt
^r4/lib/parse.txt
^r4/lib/codecolor.txt

^r4/dev/ide/tokenr4.txt
^r4/dev/ide/postr4.txt

^r4/lib/dlgfile.txt

#filename )( 1024
#code
#error
#rsize 40
#iniword


:tokeniza
	diccreset
	code loadincludes 1? ( errormsg 'error ! ; ) drop
	code code2token 1? ( errormsg 'error ! ; ) drop
    tokenpost
	"Ok." 'error !
	cntwords rsize - 1+ 'iniword !
	;


:fixbin | nro bits --
	( 1? )( 1- swap
		1 and? ( "1" )( "0" ) printx
		2/ swap ) 2drop ;

:drawline | nro -- nro
	cntwords >? ( ; )
	blanco
	dup 4 << 'indicepal +
	@+ "%s" print
	@+ swap |"%h" print
	10 col
	@+
	dup 12 >> $fff and
	0? ( 4drop ; )	| si no es llamada no mostrar
	"%d-" print
	$fff and 12 fixbin |"%b" print
	25 col
	@
	dup 24 << 24 >> "d%d " print
	dup 16 << 24 >> "u%d " print
	dup 12 << 24 >> "r%d " print
	20 >> $fff and "(%d)" print
	over dic>len@ ( 1? )( 1- swap @+ tokencolor tokenstr print sp swap ) 2drop

	;

:drawwords
	iniword
	rsize ( 1? )( 1- swap
		drawline cr
		1+ swap ) 2drop ;

:loadfile
	"r4" dlgfileload 0? ( drop ; )
	dup 'filename strcpy
	here dup 'code ! swap load 0 swap c!+ 'here !
	tokeniza
	;

:saveimg
	;

:codeprint
	'tokencod ( tokencod> <? )(
		@+ tokencolor tokenstr allowcr print sp
		) drop
	;
:main
	0 'iniword !

	"wait" 'error !
	4
	show clrscr
		fonti
		dup "%d " print
		error 'filename "%s %s" print cr
		tokencod> "%h " print cr
		drawwords

|		stackinc
|		dumpinc
|		dumpdic
|		codeprint

		[ iniword cntwords rsize - <=? ( 1+ ) 'iniword ! ; ] <dn>
		[ iniword 1? ( 1- ) 'iniword ! ; ] <up>

		'loadfile <f1>
		'saveimg <f3>

		'exit >esc<
		cminiflecha ;

: mark main ;
