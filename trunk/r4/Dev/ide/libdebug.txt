| lib debug
| 2014 PHREDA
|---------------------------
^r4/lib/gui.txt
^r4/lib/parse.txt
|^r4/lib/codecolor.txt

^r4/lib/dlgfile.txt

^r4/dev/ide/tokenr4.txt
^r4/dev/ide/plainr4.txt

#filename )( 1024
#srcode
#error
#rsize 30
#iniword

:tokenizacode
	srcode tokeniza 1? ( errormsg 'error ! ; ) drop
	"Ok." 'error !

	cntwords rsize - 1+
	-? ( 0 nip ) 'iniword !
	;

|----------
:fixbin | nro bits --
	( 1? )( 1- swap
		dup 1 and $30 + emit
		2/ swap ) 2drop ;

:drawline | nro -- nro
	cntwords >? ( ; )
	blanco
	dup 4 << 'indicepal +
	@+ "%s" print
	@+ swap |"%h" print
	10 col
	@+
	dup 24 >> $ff and "%d " print
	dup 12 >> $fff and
|	0? ( 4drop ; )	| si no es llamada no mostrar
	"%d-" print

printinfword
|	$fff and 12 fixbin |"%b" print
	28 col
	@
	dup
	sp printmovword sp

|	dup 24 << 24 >> "D%d " print
|	dup 16 << 24 >> "U%d " print
|	dup 12 << 28 >> "R%d " print
	20 >> $fff and "(%d)" print
	over dic>len@ ( 1? )( 1- swap @+ tokencolor tokenstr print sp swap ) 2drop
	;

:drawline2 | nro
	cntwords >? ( ; )
	blanco
	dup 4 << 'indicepal +
	@+ "%s " print
	4+ @+	| inf
	swap @ 	| inf mov
	printmovword
	drop
	;

:drawwords
	iniword |0? ( drop ; )
	rsize ( 1? )( 1- swap
		drawline cr
		1+ swap ) 2drop ;

|--- carga archivo y tokeniza
:loadfile
	"r4" dlgfileload 0? ( drop ; )
	dup 'filename strcpy
	here dup 'srcode ! swap load 0 swap c!+ 'here !
	tokenizacode
	;


|---------- carga..genera plain y analiza otra vez
:loadplain
	"r4" dlgfileload 0? ( drop ; )
	dup 'filename strcpy
	modoasm
	mark
	here 'srcode !
	"^r4/system/asmbase/asmbase.txt" ,ln
	here swap load 0 swap c!+ 'here !
    tokenizacode
	mark
	makeplain
	"r4asm/plain.txt" savemem
	empty
	empty
	here dup 'srcode !
	"r4asm/plain.txt" load 0 swap c!+ 'here !
	tokenizacode
	;

:codeprint
	code ( code> <? )(
		@+ tokencolor tokenstr allowcr print sp
		) drop
	;


:showerror
	poserror 0? ( drop ; )
	">>%w<<" print
	;

:generatedebughelp

	;

:genplain
|	makeplainsave
	mark makeplain empty here memmap
	;

:main
	0 'iniword !

	"wait" 'error !
	4
	show clrscr
		fonti
		dup "%d " print
		error 'filename "%s %s " print
		showerror cr

		drawwords

		infodic
		cnttokens 2 << "$%h codeinc " print
		cnttokens "%d" print
		cr
		stackinc


		dumpinc
|		dumpdic
|		codeprint

		[ iniword cntwords rsize - <=? ( 1+ ) 'iniword ! ; ] <dn>
		[ iniword 1? ( 1- ) 'iniword ! ; ] <up>
		[ iniword rsize + cntwords rsize - >? ( cntwords rsize - 1+ nip ) 'iniword ! ; ] <pgdn>
		[ iniword rsize - -? ( 0 nip ) 'iniword ! ; ] <pgup>

		'loadfile <f1>
		'loadplain <f2>
		'genplain <f3>

		'exit >esc<
		cminiflecha ;

: mark main ;
